machine:
  files:
    - content: |
        [plugins]
          [plugins."io.containerd.grpc.v1.cri"]
            [plugins."io.containerd.grpc.v1.cri".containerd]
              default_runtime_name = "nvidia"
        [metrics]
          address = "0.0.0.0:11234"
      path: /etc/cri/conf.d/20-customization.part
      op: create
    - content: |
        apiVersion: kubescheduler.config.k8s.io/v1
        kind: KubeSchedulerConfiguration
        clientConnection:
          kubeconfig: /system/secrets/kubernetes/kube-scheduler/kubeconfig
        profiles:
          - schedulerName: default-scheduler
            pluginConfig:
              - name: PodTopologySpread
                args:
                  defaultConstraints:
                    - maxSkew: 1
                      topologyKey: kubernetes.io/hostname
                      whenUnsatisfiable: ScheduleAnyway
                  defaultingType: List
      path: /var/etc/kube-scheduler-config.yaml
      permissions: 0o664
      op: create
  certSANs:
  - gamma
  - 192.168.1.252
  network:
    interfaces:
      - interface: bond0
        dhcp: false
        addresses:
        - 192.168.1.252/24
        routes:
        - network: 0.0.0.0/0
          gateway: 192.168.1.3
        bond:
          deviceSelectors:
          - hardwareAddr: '00:0f:53:*'
          mode: 802.3ad
          lacpRate: fast
  kubelet:
    nodeIP:
      validSubnets:
      - '192.168.1.252/32'
  install:
    extensions:
    - image: ghcr.io/usa-reddragon/talos-nonfree-kmod-nvidia:535.54.03-v1.5.3-1-ge4d0020
    - image: ghcr.io/usa-reddragon/talos-nvidia-container-toolkit:535.54.03-v1.13.5
  sysctls:
    net.core.bpf_jit_harden: 1
  kernel:
    modules:
    - name: nvidia
    - name: nvidia_uvm
    - name: nvidia_drm
    - name: nvidia_modeset
  sysfs:
    devices.system.cpu.cpu0.cpufreq.scaling_governor: performance
    devices.system.cpu.cpu1.cpufreq.scaling_governor: performance
    devices.system.cpu.cpu2.cpufreq.scaling_governor: performance
    devices.system.cpu.cpu3.cpufreq.scaling_governor: performance
    devices.system.cpu.cpu4.cpufreq.scaling_governor: performance
    devices.system.cpu.cpu5.cpufreq.scaling_governor: performance
    devices.system.cpu.cpu6.cpufreq.scaling_governor: performance
    devices.system.cpu.cpu7.cpufreq.scaling_governor: performance
    devices.system.cpu.cpu8.cpufreq.scaling_governor: performance
    devices.system.cpu.cpu9.cpufreq.scaling_governor: performance
    devices.system.cpu.cpu10.cpufreq.scaling_governor: performance
    devices.system.cpu.cpu11.cpufreq.scaling_governor: performance
    devices.system.cpu.cpu12.cpufreq.scaling_governor: performance
    devices.system.cpu.cpu13.cpufreq.scaling_governor: performance
    devices.system.cpu.cpu14.cpufreq.scaling_governor: performance
    devices.system.cpu.cpu15.cpufreq.scaling_governor: performance
